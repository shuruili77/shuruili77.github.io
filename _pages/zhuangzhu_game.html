---
layout: default
title: "撞珠"
permalink: /zhuangzhu/
---

<html lang="zh-CN"><head>

<script class="injected-ffc2e83d85">
(function(){'use strict';function g(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function t(a){var b=typeof Symbol!="undefined"&&Symbol.iterator&&a[Symbol.iterator];if(b)return b.call(a);if(typeof a.length=="number")return{next:g(a)};throw Error(String(a)+" is not an iterable or ArrayLike");}var v=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};
function w(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var x=w(this);function y(a,b){if(b)a:{var d=x;a=a.split(".");for(var h=0;h<a.length-1;h++){var k=a[h];if(!(k in d))break a;d=d[k]}a=a[a.length-1];h=d[a];b=b(h);b!=h&&b!=null&&v(d,a,{configurable:!0,writable:!0,value:b})}}
function z(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");}function A(){this.u=!1;this.j=null;this.v=void 0;this.g=1;this.i=this.o=0;this.A=this.h=null}function B(a){if(a.u)throw new TypeError("Generator is already running");a.u=!0}A.prototype.B=function(a){this.v=a};function C(a,b){a.h={J:b,K:!0};a.g=a.o||a.i}A.prototype.getNextAddressJsc=function(){return this.g};A.prototype.getYieldResultJsc=function(){return this.v};
A.prototype.return=function(a){this.h={return:a};this.g=this.i};A.prototype["return"]=A.prototype.return;A.prototype.H=function(a){this.h={m:a};this.g=this.i};A.prototype.jumpThroughFinallyBlocks=A.prototype.H;A.prototype.l=function(a,b){this.g=b;return{value:a}};A.prototype.yield=A.prototype.l;A.prototype.P=function(a,b){a=t(a);var d=a.next();z(d);if(d.done)this.v=d.value,this.g=b;else return this.j=a,this.l(d.value,b)};A.prototype.yieldAll=A.prototype.P;A.prototype.m=function(a){this.g=a};
A.prototype.jumpTo=A.prototype.m;A.prototype.I=function(){this.g=0};A.prototype.jumpToEnd=A.prototype.I;A.prototype.N=function(a,b){this.o=a;b!=void 0&&(this.i=b)};A.prototype.setCatchFinallyBlocks=A.prototype.N;A.prototype.O=function(a){this.o=0;this.i=a||0};A.prototype.setFinallyBlock=A.prototype.O;A.prototype.M=function(a,b){this.g=a;this.o=b||0};A.prototype.leaveTryBlock=A.prototype.M;A.prototype.D=function(a){this.o=a||0;a=this.h.J;this.h=null;return a};A.prototype.enterCatchBlock=A.prototype.D;
A.prototype.F=function(a,b,d){d?this.A[d]=this.h:this.A=[this.h];this.o=a||0;this.i=b||0};A.prototype.enterFinallyBlock=A.prototype.F;A.prototype.L=function(a,b){b=this.A.splice(b||0)[0];(b=this.h=this.h||b)?b.K?this.g=this.o||this.i:b.m!=void 0&&this.i<b.m?(this.g=b.m,this.h=null):this.g=this.i:this.g=a};A.prototype.leaveFinallyBlock=A.prototype.L;A.prototype.G=function(a){return new D(a)};A.prototype.forIn=A.prototype.G;
function D(a){this.i=a;this.g=[];for(var b in a)this.g.push(b);this.g.reverse()}D.prototype.h=function(){for(;this.g.length>0;){var a=this.g.pop();if(a in this.i)return a}return null};D.prototype.getNext=D.prototype.h;function E(a){this.g=new A;this.h=a}function G(a,b){B(a.g);var d=a.g.j;if(d)return H(a,"return"in d?d["return"]:function(h){return{value:h,done:!0}},b,a.g.return);a.g.return(b);return I(a)}
function H(a,b,d,h){try{var k=b.call(a.g.j,d);z(k);if(!k.done)return a.g.u=!1,k;var m=k.value}catch(c){return a.g.j=null,C(a.g,c),I(a)}a.g.j=null;h.call(a.g,m);return I(a)}function I(a){for(;a.g.g;)try{var b=a.h(a.g);if(b)return a.g.u=!1,{value:b.value,done:!1}}catch(d){a.g.v=void 0,C(a.g,d)}a.g.u=!1;if(a.g.h){b=a.g.h;a.g.h=null;if(b.K)throw b.J;return{value:b.return,done:!0}}return{value:void 0,done:!0}}
function J(a){this.next=function(b){B(a.g);a.g.j?b=H(a,a.g.j.next,b,a.g.B):(a.g.B(b),b=I(a));return b};this.throw=function(b){B(a.g);a.g.j?b=H(a,a.g.j["throw"],b,a.g.B):(C(a.g,b),b=I(a));return b};this.return=function(b){return G(a,b)};this[Symbol.iterator]=function(){return this}}function K(a){function b(h){return a.next(h)}function d(h){return a.throw(h)}return new Promise(function(h,k){function m(c){c.done?h(c.value):Promise.resolve(c.value).then(b,d).then(m,k)}m(a.next())})}
function L(a){return K(new J(new E(a)))}y("Symbol",function(a){function b(m){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new d(h+(m||"")+"_"+k++,m)}function d(m,c){this.g=m;v(this,"description",{configurable:!0,writable:!0,value:c})}if(a)return a;d.prototype.toString=function(){return this.g};var h="jscomp_symbol_"+(Math.random()*1E9>>>0)+"_",k=0;return b});
y("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");v(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return M(g(this))}});return a});function M(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
y("Promise",function(a){function b(c){this.h=0;this.i=void 0;this.g=[];this.u=!1;var e=this.j();try{c(e.resolve,e.reject)}catch(f){e.reject(f)}}function d(){this.g=null}function h(c){return c instanceof b?c:new b(function(e){e(c)})}if(a)return a;d.prototype.h=function(c){if(this.g==null){this.g=[];var e=this;this.i(function(){e.l()})}this.g.push(c)};var k=x.setTimeout;d.prototype.i=function(c){k(c,0)};d.prototype.l=function(){for(;this.g&&this.g.length;){var c=this.g;this.g=[];for(var e=0;e<c.length;++e){var f=
c[e];c[e]=null;try{f()}catch(l){this.j(l)}}}this.g=null};d.prototype.j=function(c){this.i(function(){throw c;})};b.prototype.j=function(){function c(l){return function(n){f||(f=!0,l.call(e,n))}}var e=this,f=!1;return{resolve:c(this.F),reject:c(this.l)}};b.prototype.F=function(c){if(c===this)this.l(new TypeError("A Promise cannot resolve to itself"));else if(c instanceof b)this.H(c);else{a:switch(typeof c){case "object":var e=c!=null;break a;case "function":e=!0;break a;default:e=!1}e?this.D(c):this.o(c)}};
b.prototype.D=function(c){var e=void 0;try{e=c.then}catch(f){this.l(f);return}typeof e=="function"?this.I(e,c):this.o(c)};b.prototype.l=function(c){this.v(2,c)};b.prototype.o=function(c){this.v(1,c)};b.prototype.v=function(c,e){if(this.h!=0)throw Error("Cannot settle("+c+", "+e+"): Promise already settled in state"+this.h);this.h=c;this.i=e;this.h===2&&this.G();this.B()};b.prototype.G=function(){var c=this;k(function(){if(c.A()){var e=x.console;typeof e!=="undefined"&&e.error(c.i)}},1)};b.prototype.A=
function(){if(this.u)return!1;var c=x.CustomEvent,e=x.Event,f=x.dispatchEvent;if(typeof f==="undefined")return!0;typeof c==="function"?c=new c("unhandledrejection",{cancelable:!0}):typeof e==="function"?c=new e("unhandledrejection",{cancelable:!0}):(c=x.document.createEvent("CustomEvent"),c.initCustomEvent("unhandledrejection",!1,!0,c));c.promise=this;c.reason=this.i;return f(c)};b.prototype.B=function(){if(this.g!=null){for(var c=0;c<this.g.length;++c)m.h(this.g[c]);this.g=null}};var m=new d;b.prototype.H=
function(c){var e=this.j();c.C(e.resolve,e.reject)};b.prototype.I=function(c,e){var f=this.j();try{c.call(e,f.resolve,f.reject)}catch(l){f.reject(l)}};b.prototype.then=function(c,e){function f(p,q){return typeof p=="function"?function(u){try{l(p(u))}catch(F){n(F)}}:q}var l,n,r=new b(function(p,q){l=p;n=q});this.C(f(c,l),f(e,n));return r};b.prototype.catch=function(c){return this.then(void 0,c)};b.prototype.C=function(c,e){function f(){switch(l.h){case 1:c(l.i);break;case 2:e(l.i);break;default:throw Error("Unexpected state: "+
l.h);}}var l=this;this.g==null?m.h(f):this.g.push(f);this.u=!0};b.resolve=h;b.reject=function(c){return new b(function(e,f){f(c)})};b.race=function(c){return new b(function(e,f){for(var l=t(c),n=l.next();!n.done;n=l.next())h(n.value).C(e,f)})};b.all=function(c){var e=t(c),f=e.next();return f.done?h([]):new b(function(l,n){function r(u){return function(F){p[u]=F;q--;q==0&&l(p)}}var p=[],q=0;do p.push(void 0),q++,h(f.value).C(r(p.length-1),n),f=e.next();while(!f.done)})};return b});
y("String.prototype.startsWith",function(a){return a?a:function(b,d){if(this==null)throw new TypeError("The 'this' value for String.prototype.startsWith must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype.startsWith must not be a regular expression");var h=this.length,k=b.length;d=Math.max(0,Math.min(d|0,this.length));for(var m=0;m<k&&d<h;)if(this[d++]!=b[m++])return!1;return m>=k}});function N(a,b,d){var h=new MutationObserver(function(k,m){var c,e,f;return L(function(l){if(l.g==1){if(a())return console.debug("Too many mutations, stopping mutation observer."),m.disconnect(),l.return();c=t(k);e=c.next()}if(l.g!=3){if(e.done)return l.m(0);f=e.value;return f.type==="childList"&&f.addedNodes.length>0?(f.addedNodes.forEach(function(n){var r;return L(function(p){if(p.g==1){if(n.nodeType!==Node.ELEMENT_NODE)return p.m(0);r=n;return p.l(d(r),3)}return r.tagName!=="IMG"?(r.querySelectorAll&&
(r.querySelectorAll("*").forEach(function(q){return L(function(u){return u.l(d(q),0)})}),r.querySelectorAll("img").forEach(function(q){return L(function(u){return u.l(b(q),0)})})),p.m(0)):p.l(b(n),0)})}),l.m(3)):f.type==="attributes"&&f.attributeName==="src"?f.target.nodeType!==Node.ELEMENT_NODE||f.target.tagName!=="IMG"?l.m(3):l.l(b(f.target),3):f.type==="attributes"&&f.attributeName==="style"&&f.target.nodeType===Node.ELEMENT_NODE?l.l(d(f.target),3):l.m(3)}e=c.next();return l.m(2)})});window.imageObserver=
h;h.observe(document,{attributes:!0,attributeFilter:["src","style"],childList:!0,subtree:!0})}var O=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");function P(a){if(O&&O.set){var b=O.set;Object.defineProperty(HTMLImageElement.prototype,"src",{set:function(d){b.call(this,d);a(this)},get:O.get,enumerable:O.enumerable,configurable:O.configurable})}};var Q=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src"),R=Q==null?void 0:Q.set,S="data:image/svg+xml;base64,"+btoa(' <svg width="1024" height="1024" viewBox="0 0 100 100" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="g" x1="-100%" y1="0" x2="0" y2="0">\n      <stop offset="0" stop-color="#b0b0b0"/>\n      <stop offset=".5" stop-color="#f0f0f0"/>\n      <stop offset="1" stop-color="#b0b0b0"/>\n\n      <animateTransform id="a" \n                        attributeName="gradientTransform" \n                        type="translate" \n                        from="0" to="2" \n                        dur="1s" begin="0s"/>\n      <animateTransform id="b" \n                        attributeName="gradientTransform" \n                        type="translate" \n                        from="0" to="2" \n                        dur="1.5s" begin="a.end"/>\n      <animateTransform attributeName="gradientTransform" \n                        type="translate" \n                        from="0" to="2" \n                        dur="2s" begin="b.end" \n                        repeatCount="indefinite"/>\n    </linearGradient>\n  </defs>\n  \n  <rect width="100" height="100" fill="url(#g)"/>\n</svg>'.replace(/\s+/g,
" "));function T(a){if(!document.baseURI||!a||a.startsWith("/"))return a;var b=(new URL(document.baseURI)).origin;return a.startsWith(b)?a.slice(b.length):a}function U(a,b){a=b===void 0||b?window.getComputedStyle(a):a.style;return a.backgroundImage&&a.backgroundImage!=="none"?(a=(a=a.backgroundImage.match(/url\(['"]?(.*?)['"]?\)/))?a[1]:null)?T(a):null:null};(function(){function a(h){return h.startsWith("/gen?prompt=")||h.startsWith("/image?query=")}function b(h){var k;(k=(k=h.getAttribute("src"))?T(k):null)&&a(k)&&(d++,R==null||R.call(h,S),(k=k.match(/aspectRatio=(\d+:\d+)$/))&&k[1]!=="1:1"&&(k=k[1].replace(":","/"),h.style.setProperty("--go-org-aspect-ratio",h.style.aspectRatio),h.style.aspectRatio=k))}var d=0;P(b);N(function(){return d>1E4},b,function(h){if(h instanceof HTMLElement){var k=U(h,!1);k||(k=U(h,!0));k&&a(k)&&(d++,h.style.setProperty("background-image",
"url('"+S+"')","important"))}})})();}).call(this);


</script>



<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
<title>撞珠 - 纪念李正伦先生</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<!-- Noto Serif SC for Chinese, Material Icons -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&amp;family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
<style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #2c241b; /* Darker background outside board to focus attention */
            color: #f3e5d8;
            overflow: hidden;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            cursor: crosshair;
            border-radius: 4px;
        }
        /* UI Panel - Glassmorphism */
        .glass-panel {
            background: rgba(44, 36, 27, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(220, 179, 92, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            background: linear-gradient(to bottom, #dcb35c, #b08d46);
            border: 1px solid #8a6e3e;
            color: #2c241b;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        .btn-primary:active {
            transform: translateY(2px);
            filter: brightness(0.95);
        }
</style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.pointer-events-auto{pointer-events:auto}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.left-4{left:1rem}.right-4{right:1rem}.top-4{top:1rem}.z-50{z-index:50}.z-20{z-index:20}.z-40{z-index:40}.mx-6{margin-left:1.5rem;margin-right:1.5rem}.mb-4{margin-bottom:1rem}.mt-1{margin-top:0.25rem}.mb-5{margin-bottom:1.25rem}.mb-1{margin-bottom:0.25rem}.mb-6{margin-bottom:1.5rem}.mb-2{margin-bottom:0.5rem}.mb-8{margin-bottom:2rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-screen{height:100vh}.h-3{height:0.75rem}.h-full{height:100%}.max-h-\[90vh\]{max-height:90vh}.w-screen{width:100vw}.w-full{width:100%}.w-3{width:0.75rem}.max-w-md{max-width:28rem}@keyframes spin{to{transform:rotate(360deg)}}.animate-spin{animation:spin 1s linear infinite}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.overflow-y-auto{overflow-y:auto}.rounded-full{border-radius:9999px}.rounded-xl{border-radius:0.75rem}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.border{border-width:1px}.border-2{border-width:2px}.border-l-4{border-left-width:4px}.border-t{border-top-width:1px}.border-\[\#dcb35c\]{--tw-border-opacity:1;border-color:rgb(220 179 92 / var(--tw-border-opacity, 1))}.border-gray-400{--tw-border-opacity:1;border-color:rgb(156 163 175 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.border-\[\#dcb35c\]\/30{border-color:rgb(220 179 92 / 0.3)}.border-gray-500{--tw-border-opacity:1;border-color:rgb(107 114 128 / var(--tw-border-opacity, 1))}.border-white{--tw-border-opacity:1;border-color:rgb(255 255 255 / var(--tw-border-opacity, 1))}.border-\[\#cba135\]{--tw-border-opacity:1;border-color:rgb(203 161 53 / var(--tw-border-opacity, 1))}.bg-\[\#1a1612\]{--tw-bg-opacity:1;background-color:rgb(26 22 18 / var(--tw-bg-opacity, 1))}.bg-\[\#2c241b\]{--tw-bg-opacity:1;background-color:rgb(44 36 27 / var(--tw-bg-opacity, 1))}.bg-black\/30{background-color:rgb(0 0 0 / 0.3)}.bg-\[\#e8e8e8\]{--tw-bg-opacity:1;background-color:rgb(232 232 232 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-\[\#1a1a1a\]{--tw-bg-opacity:1;background-color:rgb(26 26 26 / var(--tw-bg-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-black\/85{background-color:rgb(0 0 0 / 0.85)}.bg-black\/60{background-color:rgb(0 0 0 / 0.6)}.bg-white\/20{background-color:rgb(255 255 255 / 0.2)}.p-2{padding:0.5rem}.p-5{padding:1.25rem}.p-4{padding:1rem}.p-3{padding:0.75rem}.p-10{padding:2.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.px-10{padding-left:2.5rem;padding-right:2.5rem}.pt-4{padding-top:1rem}.text-center{text-align:center}.text-5xl{font-size:3rem;line-height:1}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-\[11px\]{font-size:11px}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-7xl{font-size:4.5rem;line-height:1}.text-lg{font-size:1.125rem;line-height:1.75rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-light{font-weight:300}.font-normal{font-weight:400}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-relaxed{line-height:1.625}.tracking-widest{letter-spacing:0.1em}.tracking-wider{letter-spacing:0.05em}.text-\[\#dcb35c\]{--tw-text-opacity:1;color:rgb(220 179 92 / var(--tw-text-opacity, 1))}.text-\[\#a08b70\]{--tw-text-opacity:1;color:rgb(160 139 112 / var(--tw-text-opacity, 1))}.text-\[\#e0c097\]{--tw-text-opacity:1;color:rgb(224 192 151 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-gray-200{--tw-text-opacity:1;color:rgb(229 231 235 / var(--tw-text-opacity, 1))}.opacity-90{opacity:0.9}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.drop-shadow-lg{--tw-drop-shadow:drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-500{transition-duration:500ms}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-white\/5:hover{background-color:rgb(255 255 255 / 0.05)}.group:hover .group-hover\:translate-x-1{--tw-translate-x:0.25rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@media (min-width: 768px){.md\:right-auto{right:auto}.md\:w-80{width:20rem}}@media (min-width: 1024px){.lg\:p-8{padding:2rem}}</style></head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative bg-[#1a1612]">
<!-- Loading Overlay -->
<div class="absolute inset-0 z-50 flex items-center justify-center bg-[#2c241b] text-[#dcb35c] hidden" id="loading">
<div class="flex flex-col items-center gap-4">
<span class="material-symbols-outlined text-5xl animate-spin">hourglass_empty</span>
<div class="text-xl tracking-widest font-bold">棋盘加载中...</div>
</div>
</div>
<!-- Game UI Panel -->
<div class="absolute top-4 left-4 right-4 md:right-auto md:w-80 z-20 transition-all duration-300 pointer-events-none">
<div class="glass-panel p-5 rounded-xl text-[#e0c097] pointer-events-auto flex flex-col max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-start mb-4">
<div>
<h1 class="text-3xl font-bold text-[#dcb35c] tracking-wider" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">撞珠</h1>
<p class="text-xs text-[#a08b70] mt-1 tracking-widest">围棋弹珠对战</p>
</div>
<div class="flex gap-1">
<!-- Sound Toggle -->
<button class="p-2 hover:bg-white/5 rounded-full transition-colors text-[#dcb35c]" id="btn-sound" title="开关声音">
<span class="material-symbols-outlined" id="icon-sound">volume_up</span>
</button>
<!-- Download Button -->
<button class="p-2 hover:bg-white/5 rounded-full transition-colors text-[#dcb35c]" id="btn-download" title="下载源代码">
<span class="material-symbols-outlined">download</span>
</button>
<!-- Restart Button -->
<button class="p-2 hover:bg-white/5 rounded-full transition-colors text-[#dcb35c]" id="btn-restart" title="重新开始">
<span class="material-symbols-outlined">replay</span>
</button>
</div>
</div>
<!-- Status Box -->
<div class="mb-5 p-4 rounded border-l-4 transition-all duration-300 bg-white/20 border-white" id="status-box">
<div class="text-xs uppercase text-gray-400 font-bold mb-1 tracking-widest" id="game-phase">白方回合</div>
<div class="text-sm font-medium text-white leading-relaxed" id="game-instruction">点击<span class="text-white font-bold">上方</span>粗线处放置撞珠，向后拖拽发射。</div>
</div>
<!-- Action Button -->
<button class="w-full btn-primary font-bold py-3 px-4 rounded shadow-lg mb-6 flex items-center justify-center gap-2 group hidden" id="btn-action">
<span id="btn-text">开始对战</span>
<span class="material-symbols-outlined text-xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
</button>
<!-- Score Board -->
<div class="grid grid-cols-2 gap-3 text-sm mb-6">
<!-- White Score -->
<div class="bg-[#e8e8e8] p-3 rounded shadow-inner flex flex-col items-center justify-center border border-gray-400">
<div class="text-gray-500 text-xs mb-1 font-bold">白方 (White)</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded-full bg-white border border-gray-300 shadow-sm"></div>
<span class="font-bold text-2xl text-gray-800" id="score-white">9</span>
</div>
</div>
<!-- Black Score -->
<div class="bg-[#1a1a1a] p-3 rounded shadow-inner flex flex-col items-center justify-center border border-gray-700">
<div class="text-gray-400 text-xs mb-1 font-bold">黑方 (Black)</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded-full bg-black border border-gray-600 shadow-sm"></div>
<span class="font-bold text-2xl text-gray-200" id="score-black">10</span>
</div>
</div>
</div>
<!-- Dedication Footer -->
<div class="pt-4 border-t border-[#dcb35c]/30">
<div class="text-[11px] leading-relaxed text-[#a08b70] italic font-light opacity-90">
<p class="mb-1">谨以此游戏纪念我的爷爷<span class="font-normal text-[#dcb35c]">李正伦</span>先生</p>
<p>他既是最慈爱的爷爷，也是我最好的朋友。</p>
</div>
</div>
</div>
</div>
<!-- Victory Modal -->
<div class="hidden absolute inset-0 z-40 bg-black/85 flex items-center justify-center backdrop-blur-sm transition-opacity duration-500" id="victory-modal">
<div class="glass-panel p-10 rounded-2xl text-center max-w-md mx-6 border-2 border-[#dcb35c]">
<span class="material-symbols-outlined text-7xl text-[#dcb35c] mb-6 drop-shadow-lg">emoji_events</span>
<h2 class="text-4xl font-bold text-white mb-2 tracking-widest" id="winner-text">白方获胜</h2>
<p class="text-gray-400 mb-8 text-lg">对方棋子已全部被击出棋盘</p>
<button class="btn-primary font-bold py-3 px-10 rounded-full text-lg shadow-xl hover:scale-105 transition-transform" id="btn-play-again">
            再来一局
        </button>
</div>
</div>
<!-- Canvas Container -->
<div class="relative w-full h-full flex justify-center items-center p-2 lg:p-8">
<canvas class="rounded shadow-2xl" id="gameCanvas" style="background-color: rgb(227, 192, 141); width: 601px; height: 601px;" width="800" height="800"></canvas>
</div>
<script>
    // --- Configuration ---
    const CONFIG = {
        BOARD_SIZE: 800,  // Internal resolution
        GRID_LINES: 19,
        FRICTION: 0.97,   
        STOP_THRESHOLD: 0.1,
        MAX_POWER: 40,    
        POWER_SCALE: 0.15,
        STONE_MASS: 1,
        STRIKER_MASS: 3.5,
        BOUNCE_DAMPING: 0.6
    };

    // Calculate dimensions
    const CELL_SIZE = CONFIG.BOARD_SIZE / (CONFIG.GRID_LINES + 1);
    const STONE_RADIUS = CELL_SIZE * 0.42;
    // Striker Placement Lines (Star point lines)
    const WHITE_STRIKER_LINE_INDEX = 3; 
    const BLACK_STRIKER_LINE_INDEX = 15;

    // --- Procedural Assets Generation ---
    const assets = {
        woodPattern: null,
        loaded: false
    };

    function generateWoodTexture() {
        const size = 512;
        const c = document.createElement('canvas');
        c.width = size;
        c.height = size;
        const ctx = c.getContext('2d');

        // Base color
        ctx.fillStyle = '#e3c08d'; // Light Oak base
        ctx.fillRect(0, 0, size, size);

        // Add grain lines
        ctx.lineWidth = 2;
        for (let i = 0; i < 60; i++) {
            const x = Math.random() * size;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            
            // Wavy lines
            for (let y = 0; y <= size; y += 10) {
                const offsetX = Math.sin(y * 0.02 + x) * 10 + (Math.random() - 0.5) * 5;
                ctx.lineTo(x + offsetX, y);
            }
            ctx.strokeStyle = `rgba(139, 69, 19, ${Math.random() * 0.1 + 0.05})`; // SaddleBrown with low opacity
            ctx.stroke();
        }

        // Add subtle noise
        const imageData = ctx.getImageData(0, 0, size, size);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const noise = (Math.random() - 0.5) * 15;
            data[i] = Math.max(0, Math.min(255, data[i] + noise));
            data[i+1] = Math.max(0, Math.min(255, data[i+1] + noise));
            data[i+2] = Math.max(0, Math.min(255, data[i+2] + noise));
        }
        ctx.putImageData(imageData, 0, 0);

        return c;
    }

    // Initialize Assets
    function initAssets() {
        const textureCanvas = generateWoodTexture();
        const mainCanvas = document.getElementById('gameCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        assets.woodPattern = mainCtx.createPattern(textureCanvas, 'repeat');
        assets.loaded = true;
        document.getElementById('loading').classList.add('hidden');
    }

    // --- Audio ---
    let audioCtx = null;
    let isMuted = false;
    let sounds = {};

    async function initAudio() {
        if (audioCtx) return;
        await Tone.start();
        
        // 1. Wood Knock (Collision) - Louder, more percussive
        sounds.clack = new Tone.MembraneSynth({
            pitchDecay: 0.05,
            octaves: 2,
            oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        sounds.clack.volume.value = 0; 

        // 2. Shoot (Slide/Release)
        const noise = new Tone.Noise("white");
        const filter = new Tone.AutoFilter({ frequency: "4n", baseFrequency: 400, octaves: 4 }).toDestination();
        sounds.slideEnv = new Tone.AmplitudeEnvelope({
            attack: 0.01, decay: 0.3, sustain: 0, release: 0.1
        }).connect(filter);
        noise.connect(sounds.slideEnv);
        noise.start();
        sounds.slide = sounds.slideEnv;
        sounds.slide.volume.value = -6;

        // 3. Fall (Drop off board)
        sounds.fall = new Tone.MembraneSynth({
            pitchDecay: 0.1,
            octaves: 4,
            oscillator: { type: "triangle" },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.2 }
        }).toDestination();
        sounds.fall.volume.value = -2;

        audioCtx = true;
    }

    function playSound(type, velocity = 1) {
        if (!audioCtx || isMuted) return;
        try {
            if (type === 'clack') {
                const notes = ["C5", "D5", "E5"]; 
                const note = notes[Math.floor(Math.random() * notes.length)];
                sounds.clack.triggerAttackRelease(note, "16n", undefined, Math.min(1, Math.max(0.3, velocity/10)));
            } else if (type === 'shoot') {
                sounds.slide.triggerAttackRelease("8n");
            } else if (type === 'fall') {
                sounds.fall.triggerAttackRelease("A1", "8n");
            }
        } catch(e) {}
    }

    // Sound Toggle Logic
    const btnSound = document.getElementById('btn-sound');
    const iconSound = document.getElementById('icon-sound');
    btnSound.onclick = async () => {
        if (!audioCtx) await initAudio();
        isMuted = !isMuted;
        iconSound.textContent = isMuted ? 'volume_off' : 'volume_up';
        Tone.Destination.mute = isMuted;
    };

    // --- Classes ---
    class Stone {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.radius = STONE_RADIUS;
            this.vx = 0;
            this.vy = 0;
            this.isOut = false;
        }

        update() {
            if (this.isOut) return false;
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= CONFIG.FRICTION;
            this.vy *= CONFIG.FRICTION;

            if (Math.abs(this.vx) < CONFIG.STOP_THRESHOLD && Math.abs(this.vy) < CONFIG.STOP_THRESHOLD) {
                this.vx = 0; this.vy = 0;
            }

            // Check Boundary
            if (this.x < -this.radius || this.x > CONFIG.BOARD_SIZE + this.radius ||
                this.y < -this.radius || this.y > CONFIG.BOARD_SIZE + this.radius) {
                this.isOut = true;
                playSound('fall'); 
                return true;
            }
            return Math.abs(this.vx) > 0 || Math.abs(this.vy) > 0;
        }

        draw(ctx) {
            if (this.isOut) return;
            ctx.save();
            ctx.translate(this.x, this.y);

            ctx.beginPath();
            ctx.arc(2, 2, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fill();

            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(-this.radius/3, -this.radius/3, this.radius/10, 0, 0, this.radius);
            
            if (this.color === 'black') {
                grad.addColorStop(0, '#666');
                grad.addColorStop(1, '#0a0a0a');
            } else {
                grad.addColorStop(0, '#fff');
                grad.addColorStop(1, '#ddd');
            }
            ctx.fillStyle = grad;
            ctx.fill();

            if (this.color === 'black') {
                ctx.beginPath();
                ctx.arc(-this.radius/3, -this.radius/3, this.radius/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.15)';
                ctx.fill();
            }
            ctx.restore();
        }
    }

    class Striker {
        constructor(x, y, owner) {
            this.x = x;
            this.y = y;
            this.owner = owner;
            this.width = CELL_SIZE * 1.33; 
            this.height = CELL_SIZE * 1.0;
            this.vx = 0;
            this.vy = 0;
            this.active = true;
            this.stopped = false;
        }

        update() {
            if (!this.active) return false;
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= CONFIG.FRICTION;
            this.vy *= CONFIG.FRICTION;

            if (Math.abs(this.vx) < CONFIG.STOP_THRESHOLD && Math.abs(this.vy) < CONFIG.STOP_THRESHOLD) {
                this.vx = 0; this.vy = 0;
                this.stopped = true;
            } else {
                this.stopped = false;
            }

            const margin = Math.max(this.width, this.height);
            if (this.x < -margin || this.x > CONFIG.BOARD_SIZE + margin ||
                this.y < -margin || this.y > CONFIG.BOARD_SIZE + margin) {
                this.active = false;
                this.stopped = true;
                playSound('fall');
            }
            return !this.stopped;
        }

        draw(ctx) {
            if (!this.active) return;
            ctx.save();
            ctx.translate(this.x, this.y);

            ctx.shadowColor = 'rgba(0,0,0,0.4)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 4;

            const w = this.width;
            const h = this.height;
            const r = h * 0.2; 

            ctx.beginPath();
            ctx.roundRect(-w/2, -h/2, w, h, r);
            
            const grad = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
            if (this.owner === 'black') {
                grad.addColorStop(0, '#444');
                grad.addColorStop(0.5, '#111');
                grad.addColorStop(1, '#000');
                ctx.strokeStyle = '#cba135'; 
            } else {
                grad.addColorStop(0, '#fff');
                grad.addColorStop(0.5, '#f0f0f0');
                grad.addColorStop(1, '#ccc');
                ctx.strokeStyle = '#888'; 
            }
            ctx.fillStyle = grad;
            ctx.fill();

            ctx.shadowColor = 'transparent';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.beginPath();
            ctx.roundRect(-w/2 + 4, -h/2 + 4, w - 8, h - 8, r * 0.8);
            ctx.strokeStyle = this.owner === 'black' ? 'rgba(203, 161, 53, 0.3)' : 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(0, 0, 4, 0, Math.PI * 2);
            ctx.fillStyle = this.owner === 'black' ? '#cba135' : '#aaa'; 
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(-1, -1, 1.5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fill();

            ctx.restore();
        }
    }

    // --- State & Logic ---
    const STATE = {
        SETUP_BLACK: 0,
        SETUP_WHITE: 1,
        AIM_BLACK: 2,
        AIM_WHITE: 3,
        SIMULATING: 4,
        GAME_OVER: 5
    };

    let gameState = {
        current: STATE.SETUP_BLACK,
        stones: [],
        striker: null
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let tempStriker = null;
    let pointer = { x: 0, y: 0, isDown: false };

    // --- Input ---
    function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function handleStart(x, y) {
        // Init audio on first interaction if not ready
        if (!audioCtx) initAudio();
        
        pointer.isDown = true;
        pointer.x = x; pointer.y = y;

        if (gameState.current === STATE.SETUP_BLACK || gameState.current === STATE.SETUP_WHITE) {
            const isBlack = gameState.current === STATE.SETUP_BLACK;
            const count = gameState.stones.filter(s => s.color === (isBlack ? 'black' : 'white')).length;
            
            if (count < 10) {
                if (isBlack && y < CONFIG.BOARD_SIZE/2) return;
                if (!isBlack && y > CONFIG.BOARD_SIZE/2) return;
                if (gameState.stones.some(s => Math.hypot(s.x - x, s.y - y) < s.radius * 2.1)) return;

                gameState.stones.push(new Stone(x, y, isBlack ? 'black' : 'white'));
                playSound('clack', 5); // Louder setup sound
                updateUI();
            }
        }
        else if (gameState.current === STATE.AIM_BLACK || gameState.current === STATE.AIM_WHITE) {
            const isBlack = gameState.current === STATE.AIM_BLACK;
            const lineIdx = isBlack ? BLACK_STRIKER_LINE_INDEX : WHITE_STRIKER_LINE_INDEX;
            const targetY = (lineIdx + 1) * CELL_SIZE;

            if (Math.abs(y - targetY) < CELL_SIZE * 2) {
                if (!gameState.stones.some(s => Math.hypot(s.x - x, s.y - targetY) < s.radius + CELL_SIZE)) {
                    tempStriker = new Striker(x, targetY, isBlack ? 'black' : 'white');
                    playSound('clack', 2);
                }
            }
        }
    }

    function handleMove(x, y) {
        pointer.x = x; pointer.y = y;
    }

    function handleEnd() {
        pointer.isDown = false;
        if (tempStriker && (gameState.current === STATE.AIM_BLACK || gameState.current === STATE.AIM_WHITE)) {
            const dx = tempStriker.x - pointer.x;
            const dy = tempStriker.y - pointer.y;
            const dist = Math.hypot(dx, dy);

            if (dist > 20) {
                const power = Math.min(dist * CONFIG.POWER_SCALE, CONFIG.MAX_POWER);
                const angle = Math.atan2(dy, dx);
                
                gameState.striker = tempStriker;
                tempStriker = null;
                
                gameState.striker.vx = Math.cos(angle) * power;
                gameState.striker.vy = Math.sin(angle) * power;
                
                playSound('shoot');
                gameState.current = STATE.SIMULATING;
                updateUI();
            } else {
                tempStriker = null;
            }
        }
    }

    // Bind events (also to document body to catch first interaction for audio)
    document.body.addEventListener('click', async () => { if(!audioCtx) await initAudio(); }, {once: true});

    canvas.addEventListener('mousedown', e => handleStart(getPointerPos(e).x, getPointerPos(e).y));
    window.addEventListener('mousemove', e => { if(pointer.isDown) handleMove(getPointerPos(e).x, getPointerPos(e).y) });
    window.addEventListener('mouseup', handleEnd);
    
    canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(getPointerPos(e).x, getPointerPos(e).y) }, {passive:false});
    window.addEventListener('touchmove', e => { if(pointer.isDown) handleMove(getPointerPos(e).x, getPointerPos(e).y) }, {passive:false});
    window.addEventListener('touchend', handleEnd);

    // --- Physics ---
    function resolveCollisions() {
        for (let i=0; i<gameState.stones.length; i++) {
            for (let j=i+1; j<gameState.stones.length; j++) {
                const s1 = gameState.stones[i];
                const s2 = gameState.stones[j];
                if (s1.isOut || s2.isOut) continue;

                const dx = s2.x - s1.x;
                const dy = s2.y - s1.y;
                const dist = Math.hypot(dx, dy);

                if (dist < s1.radius + s2.radius) {
                    const angle = Math.atan2(dy, dx);
                    const sin = Math.sin(angle), cos = Math.cos(angle);
                    const overlap = (s1.radius + s2.radius - dist) / 2;
                    s1.x -= overlap * cos; s1.y -= overlap * sin;
                    s2.x += overlap * cos; s2.y += overlap * sin;

                    const vx1 = s1.vx*cos + s1.vy*sin;
                    const vy1 = s1.vy*cos - s1.vx*sin;
                    const vx2 = s2.vx*cos + s2.vy*sin;
                    const vy2 = s2.vy*cos - s2.vx*sin;

                    s1.vx = (vx2*cos - vy1*sin) * CONFIG.BOUNCE_DAMPING;
                    s1.vy = (vy1*cos + vx2*sin) * CONFIG.BOUNCE_DAMPING;
                    s2.vx = (vx1*cos - vy2*sin) * CONFIG.BOUNCE_DAMPING;
                    s2.vy = (vy2*cos + vx1*sin) * CONFIG.BOUNCE_DAMPING;
                    
                    playSound('clack', Math.hypot(s1.vx, s1.vy));
                }
            }
        }

        if (gameState.striker && gameState.striker.active) {
            const str = gameState.striker;
            const w = str.width/2;
            const h = str.height/2;

            for (let s of gameState.stones) {
                if (s.isOut) continue;
                const cx = Math.max(str.x - w, Math.min(s.x, str.x + w));
                const cy = Math.max(str.y - h, Math.min(s.y, str.y + h));
                const dx = s.x - cx;
                const dy = s.y - cy;
                const dist = Math.hypot(dx, dy);

                if (dist < s.radius) {
                    let nx = dx / dist || 1; 
                    let ny = dy / dist || 0;
                    
                    const pen = s.radius - dist;
                    s.x += nx * pen;
                    s.y += ny * pen;

                    const vRelNorm = (s.vx - str.vx)*nx + (s.vy - str.vy)*ny;
                    if (vRelNorm > 0) continue;

                    const e = 0.75;
                    const j = -(1 + e) * vRelNorm / (1/CONFIG.STONE_MASS + 1/CONFIG.STRIKER_MASS);
                    
                    const ix = j * nx;
                    const iy = j * ny;

                    s.vx += ix / CONFIG.STONE_MASS;
                    s.vy += iy / CONFIG.STONE_MASS;
                    str.vx -= ix / CONFIG.STRIKER_MASS;
                    str.vy -= iy / CONFIG.STRIKER_MASS;

                    playSound('clack', Math.abs(j));
                }
            }
        }
    }

    // --- Render ---
    function drawBoard() {
        if (assets.loaded && assets.woodPattern) {
            ctx.fillStyle = assets.woodPattern;
        } else {
            ctx.fillStyle = '#e3c08d';
        }
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = '#222';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=1; i<=CONFIG.GRID_LINES; i++) {
            const p = i * CELL_SIZE;
            ctx.moveTo(p, CELL_SIZE); ctx.lineTo(p, CONFIG.BOARD_SIZE - CELL_SIZE);
            ctx.moveTo(CELL_SIZE, p); ctx.lineTo(CONFIG.BOARD_SIZE - CELL_SIZE, p);
        }
        ctx.stroke();

        ctx.fillStyle = '#111';
        [3, 9, 15].forEach(r => {
            [3, 9, 15].forEach(c => {
                ctx.beginPath();
                ctx.arc((c+1)*CELL_SIZE, (r+1)*CELL_SIZE, 3, 0, Math.PI*2);
                ctx.fill();
            });
        });

        if (gameState.current === STATE.AIM_BLACK || gameState.current === STATE.AIM_WHITE) {
            const isBlack = gameState.current === STATE.AIM_BLACK;
            const lineIdx = isBlack ? BLACK_STRIKER_LINE_INDEX : WHITE_STRIKER_LINE_INDEX;
            const y = (lineIdx + 1) * CELL_SIZE;

            ctx.save();
            ctx.strokeStyle = isBlack ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,255,0.7)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(CELL_SIZE, y);
            ctx.lineTo(CONFIG.BOARD_SIZE - CELL_SIZE, y);
            ctx.stroke();

            ctx.fillStyle = ctx.strokeStyle;
            [3, 9, 15].forEach(c => {
                 ctx.beginPath();
                 ctx.arc((c+1)*CELL_SIZE, y, 5, 0, Math.PI*2);
                 ctx.fill();
            });
            ctx.restore();
        }
    }

    function drawAim() {
        if (!tempStriker || !pointer.isDown) return;
        
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(tempStriker.x, tempStriker.y);
        ctx.lineTo(pointer.x, pointer.y);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.setLineDash([8, 6]);
        ctx.lineWidth = 2;
        ctx.stroke();

        const dx = tempStriker.x - pointer.x;
        const dy = tempStriker.y - pointer.y;
        const dist = Math.hypot(dx, dy);
        const power = Math.min(dist * CONFIG.POWER_SCALE, CONFIG.MAX_POWER);
        const angle = Math.atan2(dy, dx);
        const len = power * 4;

        const tx = tempStriker.x + Math.cos(angle) * len;
        const ty = tempStriker.y + Math.sin(angle) * len;

        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(tempStriker.x, tempStriker.y);
        ctx.lineTo(tx, ty);
        ctx.strokeStyle = tempStriker.owner === 'black' ? '#cba135' : '#fff';
        ctx.lineWidth = 4;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(tx, ty, 5, 0, Math.PI*2);
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fill();
        ctx.restore();
    }

    function loop() {
        if (canvas.width !== CONFIG.BOARD_SIZE) {
            canvas.width = CONFIG.BOARD_SIZE;
            canvas.height = CONFIG.BOARD_SIZE;
        }

        ctx.clearRect(0,0, canvas.width, canvas.height);
        drawBoard();

        if (gameState.current === STATE.SIMULATING) {
            let moving = false;
            for(let s of gameState.stones) if(s.update()) moving = true;
            if (gameState.striker) if(gameState.striker.update()) moving = true;
            resolveCollisions();

            if (!moving) {
                const lastOwner = gameState.striker.owner;
                gameState.striker.active = false;
                gameState.striker = null;

                const b = gameState.stones.filter(s => s.color === 'black' && !s.isOut).length;
                const w = gameState.stones.filter(s => s.color === 'white' && !s.isOut).length;

                if (b === 0) {
                    gameState.current = STATE.GAME_OVER;
                    showVictory("白方");
                } else if (w === 0) {
                    gameState.current = STATE.GAME_OVER;
                    showVictory("黑方");
                } else {
                    gameState.current = lastOwner === 'black' ? STATE.AIM_WHITE : STATE.AIM_BLACK;
                    updateUI();
                }
            }
        }

        gameState.stones.forEach(s => s.draw(ctx));
        if (gameState.striker) gameState.striker.draw(ctx);
        if (tempStriker) tempStriker.draw(ctx);
        drawAim();

        requestAnimationFrame(loop);
    }

    // --- UI Update ---
    const ui = {
        phase: document.getElementById('game-phase'),
        msg: document.getElementById('game-instruction'),
        statusBox: document.getElementById('status-box'),
        btn: document.getElementById('btn-action'),
        btnText: document.getElementById('btn-text'),
        sWhite: document.getElementById('score-white'),
        sBlack: document.getElementById('score-black'),
        modal: document.getElementById('victory-modal'),
        winnerText: document.getElementById('winner-text')
    };

    function updateUI() {
        const b = gameState.stones.filter(s => s.color === 'black' && !s.isOut).length;
        const w = gameState.stones.filter(s => s.color === 'white' && !s.isOut).length;
        ui.sBlack.innerText = b;
        ui.sWhite.innerText = w;
        
        ui.btn.classList.add('hidden');
        ui.statusBox.className = "mb-5 p-4 rounded border-l-4 transition-all duration-300";

        switch(gameState.current) {
            case STATE.SETUP_BLACK:
                ui.phase.innerText = "准备阶段 (黑方)";
                ui.msg.innerText = `请在下方区域布置棋子 (${b}/10)`;
                ui.statusBox.classList.add('bg-black/60', 'border-gray-500');
                if (b === 10) {
                    ui.msg.innerText = "布阵完成。";
                    ui.btn.classList.remove('hidden');
                    ui.btnText.innerText = "确认布阵";
                    ui.btn.onclick = () => { gameState.current = STATE.SETUP_WHITE; updateUI(); };
                }
                break;
            case STATE.SETUP_WHITE:
                ui.phase.innerText = "准备阶段 (白方)";
                ui.msg.innerText = `请在上方区域布置棋子 (${w}/10)`;
                ui.statusBox.classList.add('bg-white/20', 'border-white');
                if (w === 10) {
                    ui.msg.innerText = "布阵完成，准备开始！";
                    ui.btn.classList.remove('hidden');
                    ui.btnText.innerText = "开始对战";
                    ui.btn.onclick = () => { gameState.current = STATE.AIM_BLACK; updateUI(); };
                }
                break;
            case STATE.AIM_BLACK:
                ui.phase.innerText = "黑方回合";
                ui.msg.innerHTML = "点击<span class='text-[#dcb35c] font-bold'>下方</span>粗线处放置撞珠，向后拖拽发射。";
                ui.statusBox.classList.add('bg-black/60', 'border-[#cba135]');
                break;
            case STATE.AIM_WHITE:
                ui.phase.innerText = "白方回合";
                ui.msg.innerHTML = "点击<span class='text-white font-bold'>上方</span>粗线处放置撞珠，向后拖拽发射。";
                ui.statusBox.classList.add('bg-white/20', 'border-white');
                break;
            case STATE.SIMULATING:
                ui.msg.innerText = "碰撞中...";
                break;
        }
    }

    function showVictory(who) {
        ui.winnerText.innerText = `${who}获胜`;
        ui.modal.classList.remove('hidden');
    }

    function reset() {
        gameState.stones = [];
        gameState.striker = null;
        gameState.current = STATE.SETUP_BLACK;
        ui.modal.classList.add('hidden');
        updateUI();
    }

    document.getElementById('btn-restart').onclick = reset;
    document.getElementById('btn-play-again').onclick = reset;

    document.getElementById('btn-download').onclick = function() {
        const htmlContent = document.documentElement.outerHTML;
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'zhuangzhu_game.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    function resize() {
        const p = canvas.parentElement;
        const s = Math.min(p.clientWidth, p.clientHeight);
        canvas.style.width = s + 'px';
        canvas.style.height = s + 'px';
    }
    window.addEventListener('resize', resize);
    
    // Init
    initAssets(); // Generate wood texture
    resize();
    updateUI();
    requestAnimationFrame(loop);

</script>

</body></html>